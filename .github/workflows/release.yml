---
name: Build and Release

on:
  push:
    tags:
      - "*"
  workflow_dispatch:

env:
  PACKER_OUTPUT: packer/outputs/archlinux-ansible.tar
  REGISTRY: pluggero
  IMAGE_NAME: docker-archlinux-ansible

jobs:
  lint:
    name: Lint
    uses: ./.github/workflows/_lint.yml

  build:
    name: Build
    uses: ./.github/workflows/_build.yml
    needs: lint
    with:
      upload-artifact: true

  release:
    name: Release to Docker Hub
    runs-on: ubuntu-latest
    needs: build
    permissions:
      id-token: write
      attestations: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - name: Download image artifact
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6
        with:
          name: docker-image
          path: ./image

      - name: Set Release Version
        id: set_version
        run: echo "version=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT

      - name: Login to Docker Hub
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Load and push Docker image
        id: push
        run: |
          set -euo pipefail

          VERSION="${{ steps.set_version.outputs.version }}"
          FULL_IMAGE_NAME="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"

          echo "Loading Docker image from artifact..."
          docker load -i ./image/archlinux-ansible.tar

          echo "Tagging image with version ${VERSION} as latest..."
          docker tag "${FULL_IMAGE_NAME}:${VERSION}" "${FULL_IMAGE_NAME}:latest"

          echo "Pushing ${FULL_IMAGE_NAME}:${VERSION}..."
          docker push "${FULL_IMAGE_NAME}:${VERSION}"

          echo "Pushing ${FULL_IMAGE_NAME}:latest..."
          docker push "${FULL_IMAGE_NAME}:latest"

          # Get the digest for attestation
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' "${FULL_IMAGE_NAME}:${VERSION}" | cut -d'@' -f2)
          echo "digest=${DIGEST}" >> $GITHUB_OUTPUT

          echo "Release completed successfully!"

      - name: Attest build provenance
        uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3
        with:
          subject-name: docker.io/${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          subject-digest: ${{ steps.push.outputs.digest }}
          push-to-registry: true
