---
name: Build and Release

on:
  push:
    tags:
      - "*"
  workflow_dispatch:

env:
  PACKER_OUTPUT: packer/outputs/archlinux-ansible.tar
  REGISTRY: pluggero
  IMAGE_NAME: docker-archlinux-ansible

jobs:
  lint:
    name: Lint
    uses: ./.github/workflows/_lint.yml

  build:
    name: Build
    uses: ./.github/workflows/_build.yml
    needs: lint
    with:
      upload-artifact: true

  release:
    name: Release to Docker Hub
    runs-on: ubuntu-latest
    needs: build
    permissions:
      id-token: write
      attestations: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - name: Download image artifact
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6
        with:
          name: docker-image
          path: ./image

      - name: Set Release Version
        id: set_version
        run: echo "version=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT

      - name: Login to Docker Hub
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Get commit SHA and workflow URL
        id: build_metadata
        run: |
          echo "commit_sha=${GITHUB_SHA}" >> $GITHUB_OUTPUT
          echo "workflow_url=${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}" >> $GITHUB_OUTPUT

      - name: Load and push Docker image
        id: push
        run: |
          set -euo pipefail

          VERSION="${{ steps.set_version.outputs.version }}"
          FULL_IMAGE_NAME="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"

          echo "Loading Docker image from artifact..."
          docker load -i ./image/archlinux-ansible.tar

          echo "Tagging image with version ${VERSION} as latest..."
          docker tag "${FULL_IMAGE_NAME}:${VERSION}" "${FULL_IMAGE_NAME}:latest"

          echo "Pushing ${FULL_IMAGE_NAME}:${VERSION}..."
          docker push "${FULL_IMAGE_NAME}:${VERSION}"

          echo "Pushing ${FULL_IMAGE_NAME}:latest..."
          docker push "${FULL_IMAGE_NAME}:latest"

          echo "Release completed successfully!"

      - name: Generate checksums file
        id: checksums
        run: |
          set -euo pipefail

          VERSION="${{ steps.set_version.outputs.version }}"

          echo "Calculating image checksum..."
          checksum=$(sha256sum ./image/archlinux-ansible.tar | awk '{print $1}')
          echo "Checksum: $checksum"

          echo "Creating checksums file with metadata..."
          {
            echo "$checksum  archlinux-ansible.tar"
            echo ""
            echo "Build Metadata"
            echo "- Version: $VERSION"
            echo "- Git commit: ${{ steps.build_metadata.outputs.commit_sha }}"
            echo "- Workflow run: ${{ steps.build_metadata.outputs.workflow_url }}"
            echo "- Build date: $(date --utc +"%Y-%m-%d %H:%M:%S UTC")"
            echo ""
            echo "Repository: ${{ github.server_url }}/${{ github.repository }}"
          } > ./image/checksums.txt
          echo "Checksums file created."

      - name: Attest build provenance
        uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3
        with:
          subject-path: ./image/checksums.txt

      - name: Upload checksums as artifact
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: checksums-${{ steps.set_version.outputs.version }}
          path: ./image/checksums.txt
